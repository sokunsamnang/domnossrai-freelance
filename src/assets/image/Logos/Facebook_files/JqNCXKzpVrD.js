;/*FB_PKG_DELIM*/

__d("EBSMGating",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("gkx")("8747")}g.isPersistedEBTableEnabled=a}),98);
__d("EBSMProperties",[],(function(a,b,c,d,e,f){"use strict";a=["encrypted_backups_virtual_devices","secure_encrypted_backups_recovery_code_status","device_metadata","secure_encrypted_backups_epochs","secure_encrypted_backups_client_state","encrypted_backups","experiences_shared_state","occamadillo_most_recent_message_per_thread"];b={dbVersion:4,persistedTables:new Set(a),persistedTablesArray:a};c=b;f["default"]=c}),66);
__d("MAWEncryptedBackupsPersistedDB",["EBSMGating","EBSMProperties","LSMetadata","LSPlatformErrorChannel","MAWCurrentUser","MAWIndexedDBDeletion","MAWIndexedDbMetadata","Promise","QPLUserFlow","ReStoreDbClosedError","WALoggerDeferred","err","gkx","qpl","recoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] EB state DB upgrade needed"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] EB state DB onVersionChange: closing the db"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] EB state DB initialization successsful"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] EB state DB initialization: db blocked"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] EB state DB initialization failed"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Initializing EB state DB"]);n=function(){return a};return a}var o=null;function a(){if(o==null)throw c("err")("EB state IndexedDB should've been initialized");return o}var p=!1;function e(){return p}function f(a){a===void 0&&(a=!1);return!a&&!d("EBSMGating").isPersistedEBTableEnabled()?(h||(h=b("Promise"))).resolve():(h||(h=b("Promise"))).resolve().then(function(){if(o==null){c("QPLUserFlow").start(c("qpl")._(521471732,"1454"));void d("WALoggerDeferred").LOG(n());var e=indexedDB.open(d("MAWIndexedDbMetadata").ebLSDBName(d("MAWCurrentUser").getID()),c("EBSMProperties").dbVersion);return new(h||(h=b("Promise")))(function(b,f){e.onerror=function(a){c("QPLUserFlow").endFailure(c("qpl")._(521471732,"1454"),"EB state idb initialization failed"),void d("WALoggerDeferred").ERROR(m()),c("QPLUserFlow").endFailure(c("qpl")._(521477507,"1406"),"Initialisation failed. Reached onerror."),p=!1,f(a)},e.onblocked=function(){void d("WALoggerDeferred").LOG(l())},e.onsuccess=function(e){var f=e.target.result;void d("WALoggerDeferred").LOG(k());p=!1;f.onversionchange=function(){void d("WALoggerDeferred").LOG(j()),f.close(),!a&&c("gkx")("5046")&&c("LSPlatformErrorChannel").emit(new(c("ReStoreDbClosedError"))("ebsm db closed"))};c("QPLUserFlow").endSuccess(c("qpl")._(521471732,"1454"));o=f;b(f)},e.onupgradeneeded=function(a){a=a.target.result;c("QPLUserFlow").addPoint(c("qpl")._(521471732,"1454"),"eb_state_idb_upgrade_start",{data:{bool:{eb_state_upgrade:!0}}});p=!0;void d("WALoggerDeferred").LOG(i());var b=Object.keys(d("LSMetadata").metadata.tableIds);for(var e=0;e<b.length;e++){var f=b[e],g=d("LSMetadata").metadata.tableIds[Number(f)].name;c("EBSMProperties").persistedTables.has(g)&&!a.objectStoreNames.contains(g)&&a.createObjectStore(d("LSMetadata").metadata.tableIds[Number(f)].name,{autoIncrement:!0})}c("QPLUserFlow").addPoint(c("qpl")._(521471732,"1454"),"eb_state_idb_upgrade_end",{data:{bool:{eb_state_upgrade:!0}}})}})}else return o})}function q(){var a=["secure_encrypted_backups_epochs","secure_encrypted_backups_client_state"],b=Array.from(c("EBSMProperties").persistedTables).filter(function(b){return!a.includes(b)});try{if(o!=null){var d=o.transaction(b,"readwrite");b.forEach(function(a){a=d.objectStore(a);a.clear()});d.oncomplete=function(){d.db.close()}}}catch(a){c("recoverableViolation")(a,"labyrinth_web")}}function r(){if(o!=null){var a=d("MAWIndexedDbMetadata").ebLSDBName(d("MAWCurrentUser").getID());d("MAWIndexedDBDeletion").deleteDB(a,"ebsm")}}g.getEBLSDB=a;g.isDBBeingUpgraded=e;g.makeEBIDB=f;g.clearEBIDBNonPersistedRows=q;g.deleteEBIDB=r}),98);
__d("ReStoreDecryptionFailure",[],(function(a,b,c,d,e,f){"use strict";var g="ReStoreDecryptionFailure";a=function(a){babelHelpers.inheritsLoose(b,a);function b(b,c){var d;b=b+" - Encrypted LSDB was unable to decrypt an entity for table "+c;d=a.call(this,b)||this;d.message=b;d.name=g;d.tableName=c;return d}return b}(babelHelpers.wrapNativeSuper(Error));f.ERROR_NAME=g;f.ReStoreDecryptionFailure=a}),66);
__d("MAWLSDBEncryption",["I64","LSPlatformErrorChannel","MAWCryptoConsts","MAWKeychainCrypto","MAWKeychainNaClCrypto","MAWKeychainUtil","MWEARKeychainV3","ReStoreDecryptionFailure","err","nullthrows","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h,i=typeof window!=="undefined"?window:self;function j(a){a=atob(a);var b=a.length,c=new Uint8Array(b);for(var d=0;d<b;d++)c[d]=a.charCodeAt(d);return c.buffer}function k(a){var b="";a=new Uint8Array(a);var c=a.byteLength;for(var d=0;d<c;d++)b+=String.fromCharCode(a[d]);return i.btoa(b)}function l(a){return c("nullthrows")(JSON.stringify(a,function(a,b){if((h||(h=d("I64"))).isI64(b))return{type:"64",value:[b[0],b[1]]};else if(a===""||b===null||typeof b==="string"||typeof b==="number"||typeof b==="boolean"||Array.isArray(b))return b;else if(b===void 0)return{type:"u"};else if(b instanceof ArrayBuffer)return{type:"ab",value:k(b)};else if(b instanceof Uint8Array)return{l:b.byteLength,o:b.byteOffset,type:"ui8",value:k(b.buffer)};else if(b instanceof Map)return{e:l(Array.from(b.entries())),type:"m"};else if(b instanceof Set)return{type:"s",v:l(Array.from(b.values()))};else if(typeof b==="object")return{type:"o",value:l(b)};throw c("unrecoverableViolation")("Not supported","messenger_comet")}))}function m(a){return JSON.parse(a,function(a,b){if(a===""||b===null||typeof b==="string"||typeof b==="number"||typeof b==="boolean"||Array.isArray(b))return b;else if(typeof b==="object")if(b.type==="64"){b.value._tag="i64";return b.value}else if(b.type==="u")return void 0;else if(b.type==="ab")return j(b.value);else if(b.type==="ui8")return new Uint8Array(j(b.value),b.o,b.l);else if(b.type==="o")return m(b.value);else if(b.type==="m")return new Map(m(b.e));else if(b.type==="s")return new Set(m(b.v));throw c("unrecoverableViolation")("Not supported","messenger_comet")})}function a(a,b){try{var e=d("MWEARKeychainV3").getDbEncryptionKey(),f=e.key;e=e.version;e=d("MAWKeychainUtil").makeAAD(e,d("MAWCryptoConsts").CIPHER_ID);return n(f,c("nullthrows")(l(a)),e)}catch(a){throw c("err")(a.message+" - Encrypted LSDB was unable to encrypt an entity for table "+b)}}function b(a,b){try{var e=d("MAWKeychainCrypto").getKeyVersionFromCipherData(a),f=d("MWEARKeychainV3").getDbEncryptionKey(e);f=f.key;f=o(f,a,e);return c("nullthrows")(m(f))}catch(a){c("LSPlatformErrorChannel").emit(new(d("ReStoreDecryptionFailure").ReStoreDecryptionFailure)(a.message,b));throw new(d("ReStoreDecryptionFailure").ReStoreDecryptionFailure)(a.message,b)}}function n(a,b,c){b=new TextEncoder().encode(b).buffer;return d("MAWKeychainNaClCrypto").encryptTweetNaClArrayBuffer(a,new Uint8Array(b),c)}function o(a,b,c){a=d("MAWKeychainNaClCrypto").decryptTweetNaClArrayBuffer(a,b,c);return new TextDecoder().decode(a)}g.stringify=l;g.parse=m;g.encryptLSDBObj=a;g.decryptLSDBObj=b}),98);
__d("MWBroadcastChannelPolyfill",["FBLogger","LocalStorageWrapper","MessengerLogHistory","Random","recoverableViolation","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MessengerLogHistory").getInstance("client_init");function a(a){h.debug("[MWBroadcastChannelPolyfill] "+a)}function i(a){c("FBLogger")("messenger_browser_clients").mustfix(a)}var j={},k=d("LocalStorageWrapper").getStorage(a);function b(a){var b="$BroadcastChannel$"+a+"$",e=!1,f=function(a){if(a.storageArea!==k)return;var c=a.newValue;if(c==null||c==="")return;if(((a=a.key)==null?void 0:a.substring(0,b.length))!==b)return;var d=JSON.parse(c);(a=j[b])==null?void 0:a.forEach(function(a){a({data:d})})};window.addEventListener("storage",f);return{addEventListener:function(a,c){j[b]=j[b]||new Set(),j[b].add(c)},close:function(){if(e)return;e=!0;j={};window.removeEventListener("storage",f)},postMessage:function(a){if(e){c("recoverableViolation")("Broadcast channel is closed","messenger_web_product");return}a=JSON.stringify(a);var f=b+String(Date.now())+"$"+String(c("Random").uint32());d("LocalStorageWrapper").setItemGuarded(k,f,a,i);c("setTimeout")(function(){d("LocalStorageWrapper").removeItemGuarded(k,f,i)},500)},removeEventListener:function(a,c){(a=j[b])==null?void 0:a["delete"](c)}}}g["default"]=b}),98);
__d("MWBroadcastChannel",["MWBroadcastChannelPolyfill"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return self.BroadcastChannel!=null?new self.BroadcastChannel(a):c("MWBroadcastChannelPolyfill")(a)}g.MWBroadcastChannel=a}),98);
__d("MWLSIndexedDBName",["MAWCurrentUser","MWLSDatabaseNames"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("MAWCurrentUser").getID();return d("MWLSDatabaseNames").lightspeedPrefix+a}g.dbName=a}),98);
__d("MWTabNotifier",["CurrentMessengerUser","FBLogger","MWBroadcastChannel","MWLSIndexedDBName"],(function(a,b,c,d,e,f,g){"use strict";var h=d("CurrentMessengerUser").getIDorEIMU();function a(a){var b=d("MWBroadcastChannel").MWBroadcastChannel(a==="restore-table-"+h+"-"+d("MWLSIndexedDBName").dbName()?"mwChat-"+h:a);function e(a,d){try{b.postMessage([a,d])}catch(a){c("FBLogger")("messenger_browser_clients").catching(a).warn("Failed to broadcast changes")}}function f(a,c){b.addEventListener("message",function(b){b=b.data;var d=b[0];d===a&&c(b[1])})}return{onEventReceive:f,postMessage:e}}g["default"]=a}),98);
__d("createReStoreWarmEBTablesPersistence",["ClientConsistencyEventEmitter","CurrentMessengerUser","EBSMProperties","FBLogger","MAWEncryptedBackupsPersistedDB","MAWLSDBEncryption","MWTabNotifier","Promise","QPLUserFlow","ReStorePersistence","WALoggerDeferred","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Loaded data from EB State db to in memory ReStore"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Hydrated ",": "," rows"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] DB corruption detected - deleting EBSM db"]);k=function(){return a};return a}e=d("CurrentMessengerUser").getIDorEIMU();var l=c("MWTabNotifier")==null?void 0:c("MWTabNotifier")("mwChat-"+e);function m(a,b,c){return(a.has(b)?a:a.set(b,c())).get(b)}var n=null,o=!1;function a(a,e){var f=(h||(h=b("Promise"))).resolve(),g=new Map();function i(a){return m(g,a,function(){return new Map()})}c("QPLUserFlow").start(c("qpl")._(521481876,"1407"));function j(){if(e==null){c("QPLUserFlow").endFailure(c("qpl")._(521481876,"1407"),"Hydration failed.");return(h||(h=b("Promise"))).reject()}var a=r(e);return a.then(function(a){a.forEach(function(a,b){var c=i(b);a.forEach(function(a,b){c.set(b.key,b.value)})})}).then(function(){c("QPLUserFlow").endSuccess(c("qpl")._(521481876,"1407"))})}n=j();l==null?void 0:l.onEventReceive("flushChangesV2",function(a){var b=a.changeSet,c=a.sentinelDeleted;b.forEach(function(a,b){var e=i(b);a.forEach(function(a,b){d("ReStorePersistence").isDeletedValue(a,c)?e["delete"](b):e.set(b,a)})})});return{flush:function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,c){b.size>0&&b.forEach(function(a,c){a.size===0&&b["delete"](c)}),b.size>0&&(yield a(b),b.forEach(function(a,b){var c=i(b);a.forEach(function(a,b){d("ReStorePersistence").isDeletedValue(a,d("ReStorePersistence").sentinelDeleted)?c["delete"](b):c.set(b,a)})}),l==null?void 0:l.postMessage("flushChangesV2",{changeSet:b,fromVersion:"",sentinelDeleted:d("ReStorePersistence").sentinelDeleted,version:""}))});function e(a,b){return c.apply(this,arguments)}return e}(),get:function(a,c,d){var e=i(c);if(o)return e.get(d);return n==null?(h||(h=b("Promise"))).reject("rehydration is not complete"):n.then(function(){o=!0;return e.get(d)})},logError:function(a,b,e,f){if(e==="dbCorruption"){void d("WALoggerDeferred").ERROR(k());c("FBLogger")("labyrinth_web").mustfix("Got unexpected undefined in ebsm, mode: %s, table: %s, id: %s, deletedInThisTxn: %s. Deleting EBSM db",b,a,(e=f==null?void 0:f.id)!=null?e:"",(b=f==null?void 0:f.deletedInThisTxn)!=null?b:"");d("MAWEncryptedBackupsPersistedDB").deleteEBIDB();c("ClientConsistencyEventEmitter").emit("hardRefresh","ls_forced_refresh")}},queueCommitWork:void 0,runExclusively:function(a){return new(h||(h=b("Promise")))(function(c,d){f=f.then(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{c(yield a())}catch(a){d(a)}}))})},shouldApplySync:function(){return!1},shouldSync:function(){return!1},types:["ephemeral"],uniqueId:""}}function p(a){var b=[];a=a;while(a!==0)b.push(a.hd),a=a.tl;return b}function q(a,c){var e=a.transaction(c,"readonly"),f=[],g=e.objectStore(c).openCursor();return new(h||(h=b("Promise")))(function(a,b){g.onsuccess=function(a){a=a.target.result;if(a){var b=a.key,e=a.value;e=d("MAWLSDBEncryption").decryptLSDBObj(e,c);e!=null&&e.isLeaf!==void 0&&(e.keys.length>0&&!Array.isArray(e.keys[0])&&(e.keys=e.keys.filter(function(a){return a!=null&&typeof a==="object"&&!Array.isArray(a)}).map(function(a){return p(a)})));f.push({key:b,value:e});a["continue"]()}},g.onerror=function(a){return b(a)},e.oncomplete=function(){a(f)}})}function r(a){var e=new Map();return d("MAWEncryptedBackupsPersistedDB").isDBBeingUpgraded()?(h||(h=b("Promise"))).resolve(e):(h||(h=b("Promise"))).all(Array.from(c("EBSMProperties").persistedTables).map(function(c){if(!a.objectStoreNames.contains(c))return(h||(h=b("Promise"))).resolve();var f=q(a,c),g=new Map();return f.then(function(a){a.map(function(a,b){g.set(a,b)}),void d("WALoggerDeferred").LOG(j(),c,g.size),e.set(c,g)})})).then(function(){void d("WALoggerDeferred").LOG(i());return(h||(h=b("Promise"))).resolve(e)})}g["default"]=a}),98);
__d("EBInMemoryTablesChangeDataSink",["MAWBridgeFireAndForget"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a===void 0&&(a=!1);return function(b){if(a)return;d("MAWBridgeFireAndForget").fireAndForget("backend","writeLSDBToPersistedEBTables",{changeSet:b})}}g.putChangeSet=a}),98);
__d("createReStoreTableNameAllowListPersistence",["Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";var g;function a(a,c,d){return{clearCache:function(){a.clearCache==null?void 0:a.clearCache(),c.clearCache==null?void 0:c.clearCache()},close:function(){a.close==null?void 0:a.close(),c.close==null?void 0:c.close()},flush:function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(e,f){var h=new Map(),i=new Map();e.forEach(function(a,b){d.has(b)?i.set(b,a):h.set(b,a)});yield (g||(g=b("Promise"))).all([a.flush(h,f),c.flush(i,f)])});function f(a,b){return e.apply(this,arguments)}return f}(),get:function(b,e,f,g){return d.has(e)?c.get(b,e,f,g):a.get(b,e,f,g)},isClosed:function(){return(a.isClosed==null?void 0:a.isClosed())||!1},logError:function(b,e,f,g){d.has(b)?c.logError==null?void 0:c.logError(b,e,f,g):a.logError==null?void 0:a.logError(b,e,f,g)},queueCommitWork:a.queueCommitWork,runExclusively:function(b){return a.runExclusively(function(){return c.runExclusively(b)})},shouldApplySync:function(b,e){if(d.has(e))return c.shouldApplySync(b,e);else return a.shouldApplySync(b,e)},shouldSync:function(b,e){if(d.has(e))return c.shouldSync(b,e);else return a.shouldSync(b,e)},types:[].concat(a.types,c.types),uniqueId:c.uniqueId+a.uniqueId}}f["default"]=a}),66);
__d("LSJSEBInMemoryStorage",["EBInMemoryTablesChangeDataSink","EBSMProperties","createReStoreEphemeralPersistence","createReStoreTableNameAllowListPersistence","createReStoreWarmEBTablesPersistence"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){b===void 0&&(b=!1);b=c("createReStoreTableNameAllowListPersistence")(c("createReStoreEphemeralPersistence")(),c("createReStoreWarmEBTablesPersistence")(d("EBInMemoryTablesChangeDataSink").putChangeSet(b),a),c("EBSMProperties").persistedTables);return b}g.makeReStorePersistence=a}),98);
__d("MWSetupEBStateDB",["FBLogger","LSJSEBInMemoryStorage","MAWEncryptedBackupsPersistedDB","MWSetupDBEncryption","QPLUserFlow","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a===void 0&&(a=!1);c("QPLUserFlow").start(c("qpl")._(521477507,"1406"));var b,e=(yield d("MWSetupDBEncryption").init());if(e.success){e=(yield d("MAWEncryptedBackupsPersistedDB").makeEBIDB(a));e==null?(c("QPLUserFlow").endFailure(c("qpl")._(521477507,"1406"),"Initialisation failed. Idb is null"),c("FBLogger")("labyrinth_web").warn("[labyrinth_web] EB State IDB initialization failed. Falling back to In memory ReStore db")):(b=d("LSJSEBInMemoryStorage").makeReStorePersistence(e,a),c("QPLUserFlow").endSuccess(c("qpl")._(521477507,"1406")))}else c("QPLUserFlow").endFailure(c("qpl")._(521477507,"1406"),"Encryption DB Initialisation failed"),c("FBLogger")("labyrinth_web").warn("[labyrinth_web] Encryption DB init failed. Falling back to In memory ReStore db");return b});return h.apply(this,arguments)}g.makeEBStateDB=a}),98);